{% extends "radar/base_mailbox.html" %}

{% block extra_head %}
<script>
var mailbox_slug = "{{ mailbox_slug }}";

var recolor_table = function() {
    mark_odd('table.subscription-list tbody tr', 'odd');
};



$(document).ready(function() {
    recolor_table();
    
    $('table.subscription-list .delete-button').live('click', function(evt) {
        evt.preventDefault();
        var row = $(evt.target).closest('tr')
        var delete_slug = row.attr('id');
        var sub_name = row.attr('title');

        
        var do_delete = function() {
            $.ajax({
                type: 'DELETE',
                url: '/' + mailbox_slug + '/subscriptions/' + delete_slug,
                complete: function(req) {
                    if (req.status == 200) {
                        row.remove();
                        recolor_table();
                    }
                    else {
                        $('<div></div>')
                            .html('Failed to delete subcription!')
                            .dialog({
                                modal: true,
                                autoOpen: true,
                                title: "Error",
                                buttons: {
                                    'Ok': function() {$(this).dialog("close");}
                                }
                            });
                    }
                }
            });
        };
        
        var delete_html = "<p><span class=\"ui-icon ui-icon-alert dialog-icon\"></span>Delete subscription to <strong>" + sub_name + "</strong>?</p>";        
        $('<div></div>')
            .html(delete_html)
        	.dialog({
        		modal: true,
        		autoOpen: true,
        		title: 'Confirm Delete Subscription',
        		buttons: {
        			'Delete': function() {
        			    $(this).dialog("close");
        			    do_delete();
        			},
        			'Cancel': function() {
        			    $(this).dialog("close");
        			}
        		}
        	});
    });
});
</script>
{% endblock %}

{% block content %}



<div id="subscriptions">
    <h1>Subscriptions</h1>
    {% if user.has_perm(PERM_EDIT, mailbox) %}
    <button class="add-subscription" title="New Subscription">
        <span class="button-text">New Subscription</span>
    </button>
    {% endif %}

    <table class="subscription-list">
        <thead>
            <tr>
                <th class="title">Name</th>
                {% if user.has_perm(PERM_EDIT, mailbox) %}
                <th class="status">Status</th>
                <th class="update">Last Update</th>
                <th class="actions"></th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for sub in subscriptions %}
            <tr id="{{sub.id}}" title="{{sub.title}}">
                <td class="title">
                    {% if sub.url %}
                    <a href="{{sub.url}}" title="{{sub.title}}">{{sub.title}}</a>
                    {% else %}
                    <span title="{{sub.title}}">{{sub.title}}</span>
                    {% endif %}
                </td>
                {% if user.has_perm(PERM_EDIT, mailbox) %}
                <td class="status">
                    {% if sub.status == 'error' %}
                    <span class="subscription-error">Error</span>
                    {% else %}
                    <span class="subscription-ok">OK</span>
                    {% endif %}
                </td>
                <td class="update">
                    {{ sub.last_update|brief_date(TIME_ZONE) }}
                </td>
                <td class="actions">
                    {% if user.has_perm(PERM_UPDATE, mailbox) %}
                    <button class="edit-button" title="Edit">Edit</button>
                    <button class="delete-button" title="Delete">Delete</button>
                    {% endif %}
                </td>
                {% endif %}
                
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}